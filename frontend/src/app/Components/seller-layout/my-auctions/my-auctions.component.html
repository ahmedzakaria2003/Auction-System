<div class="auctions-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h2 class="text-auction-gold">
        <i class="fas fa-gavel me-2"></i>
        مزاداتي
      </h2>
      <p class="text-muted">إدارة مزاداتي الخاصة</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-auction" (click)="showCreateModal = true">
        <i class="fas fa-plus me-2"></i>
        إنشاء مزاد جديد
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="row">
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="selectedStatus" (change)="loadAuctions()">
          <option value="">جميع الحالات</option>
          <option value="open">مفتوح</option>
          <option value="closed">مُغلق</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="selectedCategory" (change)="loadAuctions()">
          <option value="">جميع الفئات</option>
          <option *ngFor="let category of categories" [value]="category.id">{{category.name}}</option>
        </select>
      </div>
      <div class="col-md-4">
        <div class="search-box">
          <input type="text" class="form-control" placeholder="البحث في المزادات..."
                 [(ngModel)]="searchTerm" (input)="loadAuctions()">
          <i class="fas fa-search search-icon"></i>
        </div>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">
          <i class="fas fa-refresh me-2"></i>إعادة تعيين
        </button>
      </div>
    </div>
  </div>

  <!-- Auctions Table -->
<div class="auctions-table-container">
  <div class="table-responsive">
    <table class="table auctions-table">
      <thead>
        <tr>
          <th>الصورة</th>
          <th>عنوان المزاد</th>
          <th>الفئة</th>
          <th>السعر الابتدائي</th>
          <th>عدد المزايدات</th>
          <th>الحالة</th>
          <th>تاريخ الانتهاء</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        <!-- عرض المزادات -->
        <tr *ngFor="let auction of filteredAuctions" class="auction-row">
          <td>
            <div class="auction-image">
              <img [src]="(auction.thumbnailImage && auction.thumbnailImage[0]) ? normalizeImageUrl(auction.thumbnailImage[0]) : ''"
                   alt="{{auction.title}}" class="img-thumbnail"
                   *ngIf="auction.thumbnailImage && auction.thumbnailImage[0]">
              <span *ngIf="!auction.thumbnailImage || !auction.thumbnailImage[0]" class="text-muted">
                لا يوجد صورة
              </span>
            </div>
          </td>
          <td>
            <div class="auction-title">
              <h6 class="mb-1">{{auction.title}}</h6>
              <small class="text-muted">ID: {{auction.id.substring(0, 8)}}...</small>
            </div>
          </td>
          <td><span class="category-badge">{{auction.categoryName}}</span></td>
          <td><span class="price">${{auction.startingPrice | number:'1.2-2'}}</span></td>
          <td>
            <span class="bids-count"><i class="fas fa-hand-paper me-1"></i>{{auction.bidsCount}}</span>
          </td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(auction.auctionStatus)">
              {{getStatusText(auction.auctionStatus)}}
            </span>
          </td>
          <td><span class="end-time">{{formatDate(auction.endTime)}}</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-warning" (click)="editAuction(auction.id)" title="تعديل" [disabled]="auction.auctionStatus === 'closed' || auction.auctionStatus === 'canceled'">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-success" (click)="declareWinner(auction.id)" title="إعلان الفائز" [disabled]="auction.auctionStatus !== 'closed' || auction.bidsCount === 0">
                <i class="fas fa-trophy"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteAuction(auction.id)" title="حذف">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>

        <!-- رسالة في حالة عدم وجود مزادات -->
        <tr *ngIf="filteredAuctions.length === 0">
          <td colspan="8" class="text-center  text-danger">
            {{ noAuctionsMessage }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


       <!-- Pagination -->
      <div class="pagination-container">
        <nav>
          <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="changePage(currentPage - 1)">السابق</a>
            </li>
            <li class="page-item" *ngFor="let page of getPageNumbers()" 
                [class.active]="page === currentPage">
              <a class="page-link" (click)="changePage(page)">{{page}}</a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <a class="page-link" (click)="changePage(currentPage + 1)">التالي</a>
            </li>
          </ul>
        </nav>
      </div>
</div>

<!-- Winner Modal -->
<div class="modal fade" [class.show]="showWinnerModal" [style.display]="showWinnerModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-auction-gold"><i class="fas fa-trophy me-2"></i>تفاصيل الفائز</h5>
        <button type="button" class="btn-close" (click)="showWinnerModal = false"></button>
      </div>
      <div class="modal-body" *ngIf="selectedWinner">
        <div class="winner-report text-center">
          <i class="fas fa-crown fa-3x text-auction-gold mb-3"></i>
          <h3>فائز المزاد: {{ selectedWinner.winnerName }}</h3>
          <h4>المبلغ الفائز: ${{ selectedWinner.winningAmount || 0 | number:'1.2-2' }}</h4>
          <p><strong>عنوان المزاد:</strong> {{ selectedWinner.auctionTitle }}</p>
          <p><strong>البريد الإلكتروني:</strong> {{ selectedWinner.email }}</p>
          <p><strong>رقم الهاتف:</strong> {{ selectedWinner.phoneNumber || 'غير متوفر' }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showWinnerModal = false">إغلاق</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Auction Modal -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-auction-gold"><i class="fas fa-plus me-2"></i>إنشاء مزاد جديد</h5>
        <button type="button" class="btn-close" (click)="showCreateModal = false"></button>
      </div>
      <div class="modal-body">
           <div *ngIf="createAuctionErrorMessage" class="alert alert-danger">
          {{ createAuctionErrorMessage }}
        </div>
        <form [formGroup]="auctionForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">عنوان المزاد <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="Title">
                <div *ngIf="auctionForm.get('Title')?.touched && auctionForm.get('Title')?.invalid" class="text-danger">
                  <span *ngIf="auctionForm.get('Title')?.errors?.['required']">العنوان مطلوب</span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">الفئة <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="CategoryId">
                  <option value="">اختر الفئة</option>
                  <option *ngFor="let category of categories" [value]="category.id">{{category.name}}</option>
                </select>
                <div *ngIf="auctionForm.get('CategoryId')?.touched && auctionForm.get('CategoryId')?.invalid" class="text-danger">
                  <span *ngIf="auctionForm.get('CategoryId')?.errors?.['required']">الفئة مطلوبة</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">الوصف <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" formControlName="Description"></textarea>
            <div *ngIf="auctionForm.get('Description')?.touched && auctionForm.get('Description')?.invalid" class="text-danger">
              <span *ngIf="auctionForm.get('Description')?.errors?.['required']">الوصف مطلوب</span>
              <span *ngIf="auctionForm.get('Description')?.errors?.['minlength']">الوصف يجب أن يكون على الأقل 10 حروف</span>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">السعر الابتدائي <span class="text-danger">*</span></label>
                <input type="number" class="form-control" formControlName="StartingPrice">
                <div *ngIf="auctionForm.get('StartingPrice')?.touched && auctionForm.get('StartingPrice')?.invalid" class="text-danger">
                  <span *ngIf="auctionForm.get('StartingPrice')?.errors?.['required']">السعر مطلوب</span>
                  <span *ngIf="auctionForm.get('StartingPrice')?.errors?.['min']">يجب أن يكون السعر أكبر من 0</span>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">تاريخ البداية</label>
                <input type="datetime-local" class="form-control" formControlName="StartTime" [min]="minDateTime">
              </div>
            </div>

            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">تاريخ النهاية</label>
                <input type="datetime-local" class="form-control" formControlName="EndTime" [min]="minDateTime">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">صور المزاد</label>
            <input type="file" class="form-control" multiple accept="image/*" (change)="onCreateFileSelect($event)">
          </div>

          <!-- معاينة الصور الجديدة (Create) -->
          <div class="mb-3" *ngIf="createNewPreviews.length">
            <label class="form-label">معاينة الصور</label>
            <div class="d-flex flex-wrap gap-2">
              <img *ngFor="let p of createNewPreviews" [src]="p" class="img-thumbnail" style="width:120px;height:120px;object-fit:cover;">
            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showCreateModal = false">إلغاء</button>
        <button type="button" class="btn btn-auction" (click)="createAuction()" [disabled]="auctionForm.invalid">إنشاء المزاد</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Auction Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-auction-gold"><i class="fas fa-edit me-2"></i>تعديل المزاد</h5>
        <button type="button" class="btn-close" (click)="showEditModal = false"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">عنوان المزاد <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="Title">
                <div *ngIf="editForm.get('Title')?.touched && editForm.get('Title')?.invalid" class="text-danger">
                  <span *ngIf="editForm.get('Title')?.errors?.['required']">العنوان مطلوب</span>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">الفئة <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="CategoryId">
                  <option value="">اختر الفئة</option>
                  <option *ngFor="let category of categories" [value]="category.id">{{category.name}}</option>
                </select>
                <div *ngIf="editForm.get('CategoryId')?.touched && editForm.get('CategoryId')?.invalid" class="text-danger">
                  <span *ngIf="editForm.get('CategoryId')?.errors?.['required']">الفئة مطلوبة</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">الوصف <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" formControlName="Description"></textarea>
            <div *ngIf="editForm.get('Description')?.touched && editForm.get('Description')?.invalid" class="text-danger">
              <span *ngIf="editForm.get('Description')?.errors?.['required']">الوصف مطلوب</span>
              <span *ngIf="editForm.get('Description')?.errors?.['minlength']">الوصف يجب أن يكون على الأقل 10 حروف</span>
            </div>
          </div>

          <!-- صور قديمة (عرض فقط) -->
          <div class="mb-3" *ngIf="editOldImages.length">
            <label class="form-label">الصور الحالية</label>
            <div class="d-flex flex-wrap gap-2">
              <img *ngFor="let img of editOldImages" [src]="img" class="img-thumbnail" style="width:120px;height:120px;object-fit:cover;">
            </div>
          </div>

          <!-- رفع صور جديدة (اختياري) -->
          <div class="mb-3">
            <label class="form-label">صور المزاد</label>
            <input type="file" class="form-control" multiple accept="image/*" (change)="onEditFileSelect($event)">
          </div>

          <!-- معاينة الصور الجديدة (Edit) -->
          <div class="mb-3" *ngIf="editNewPreviews.length">
            <label class="form-label">معاينة الصور الجديدة</label>
            <div class="d-flex flex-wrap gap-2">
              <img *ngFor="let p of editNewPreviews" [src]="p" class="img-thumbnail" style="width:120px;height:120px;object-fit:cover;">
            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showEditModal = false">إلغاء</button>
        <button type="button" class="btn btn-auction" (click)="saveEditAuction()" [disabled]="editForm.invalid">حفظ التعديلات</button>
      </div>
    </div>
  </div>

</div>


